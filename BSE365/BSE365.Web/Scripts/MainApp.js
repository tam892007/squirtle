var mainApp=angular.module("mainApp",["ui.router","ui.bootstrap","authApp","ngResource","ui.tree","smart-table","underscore","angularFileUpload","ngImgCrop","ngMessages","angular-loading-bar","ui.validate","reCAPTCHA","commonApp","ui-notification"]);mainApp.config(["$stateProvider","$urlRouterProvider",function(e,r){r.otherwise("/login"),e.state("home",{url:"/",templateUrl:"app/main/home/home.html"}).state("login",{url:"/login",templateUrl:"app/authentication/login/login.html",controller:"loginController"}).state("refresh",{url:"/refresh",templateUrl:"app/authentication/refresh/refresh.html",controller:"refreshController"}).state("pin",{url:"/pin",templateUrl:"app/main/pin/pin.html",controller:"pinController"}).state("user",{"abstract":!0,url:"/user",templateUrl:"app/main/user/user-info.html",controller:"userController"}).state("user.default",{url:"/",templateUrl:"app/main/user/user-info.default.html",controller:"userDefaultController"}).state("user.register",{url:"/register",templateUrl:"app/main/user/user-info.register.html",controller:"userRegisterController"}).state("user.tree",{url:"/tree",templateUrl:"app/main/user/user-info.tree.html",controller:"userTreeController"}).state("association",{url:"/association",templateUrl:"app/main/association/association.html",controller:"associationController"})}]),mainApp.config(["$httpProvider",function(e){e.interceptors.push("authInterceptorService")}]),mainApp.run(["authService",function(e){e.fillAuthData()}]),mainApp.config(["treeConfig",function(e){e.defaultCollapsed=!0}]),mainApp.config(["cfpLoadingBarProvider",function(e){e.includeSpinner=!1}]),mainApp.config(["reCAPTCHAProvider","recaptchaSettings",function(e,r){e.setPublicKey(r.publicKey),e.setOptions({theme:"red"})}]),mainApp.config(["NotificationProvider",function(e){e.setOptions({delay:1500,startTop:20,startRight:10,verticalSpacing:20,horizontalSpacing:20,positionX:"right",positionY:"bottom",closeOnClick:!0,maxCount:3})}]),mainApp.controller("associationController",["$scope","userService","authService","$state",function(e,r,t,n){e.init=function(){e.associatedUsrs=[],e.selectedUsr={}},e.init(),e.getAssociation=function(){r.getCurrentAssociation(function(r){e.associatedUsrs=r})},e.getAssociation(),e["switch"]=function(r){e.selectedUsr.id!=r.id&&(e.password="",e.selectedUsr=r)},e.login=function(){var r={userName:e.selectedUsr.userName,password:e.selectedUsr.password,useRefreshTokens:!1};t.login(r).then(function(e){n.go("home")},function(r){e.message="Wrong password!"})},e.isMain=function(r){return null==r||r.userName.endsWith("A")||1==e.associatedUsrs.length}}]),mainApp.controller("indexController",["$scope","$state","authService","userService",function(e,r,t,n){e.logOut=function(){t.logOut(),r.go("login")},e.authentication=t.authentication,e.$on("user:authenticated",function(r,t){e.getUserContext()}),e.$on("user:updateAvatar",function(r,t){e.userContext.avatar.url=t}),e.getUserContext=function(){n.getCurrentUserContext(function(r){e.userContext=r})},e.getUserContext()}]),mainApp.controller("pinController",["$scope","userService","pinService","$q","Notification","$state",function(e,r,t,n,a,i){e.getCurrentUserPinInfo=function(){return r.getCurrentUserPinInfo().$promise},e.getCurrentUserPinTransactionHistory=function(){return t.getCurrentUserHistory().$promise},e.init=function(){e.failed=0,e.submitted=!1,e.currentPinBalance={},e.transactionHistories=[],e.getCurrentUserPinInfo().then(function(r){e.currentPinBalance=r}),e.getCurrentUserPinTransactionHistory().then(function(r){e.transactionHistories=r}),e.transaction={}},e.init(),e.transferPIN=function(){e.submitted=!0,e.frmTransfer.$valid&&t.transfer(e.transaction,function(e){a.success("Transaction has been completed successfully"),i.reload()},function(r){e.failed=1,"invalid_captcha"==r.data.message&&(e.failed=2)})},e.interacted=function(r){return e.submitted||r.$dirty},e.validateUser=function(e){var t=n.defer();return r.checkName({name:e},function(e){e.result?t.resolve(e):t.reject(e)}),t.promise}}]),mainApp.factory("pinService",["$resource",function(e){return e(":path",{},{transfer:{method:"POST",params:{path:"api/pin/transfer",transactionVM:"transactionVM"}},getCurrentUserHistory:{method:"GET",params:{path:"api/pin/getAll"},isArray:!0}})}]),mainApp.controller("dlgChangeAvatarController",["$scope","userService","FileUploader","_","localStorageService","$uibModalInstance","Notification",function(e,r,t,n,a,i,o){e.uploadImage=function(){var e=n.last(s.queue);e.upload()};var s=e.uploader=new t({autoUpload:!1,url:"api/user/updateAvatar"});s.filters.push({name:"size",fn:function(e){return e.size<=5242880}}),s.filters.push({name:"image",fn:function(e){return s.hasHTML5?/\/(png|jpeg|jpg)$/.test(e.file.type):!0}});var u=a.get("authorizationData");u&&(s.headers.Authorization="Bearer "+u.token),s.onAfterAddingFile=function(r){e.cropped={image:""};var t=new FileReader;t.onload=function(r){e.$apply(function(){e.image=r.target.result})},t.readAsDataURL(r._file)},s.onBeforeUploadItem=function(r){var t=l(e.cropped.image);r._file=t};var l=function(e){var r;r=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):decodeURI(e.split(",")[1]);for(var t=e.split(",")[0].split(":")[1].split(";")[0],n=[],a=0;a<r.length;a++)n.push(r.charCodeAt(a));return new Blob([new Uint8Array(n)],{type:t})};s.onSuccessItem=function(r,t,n,a){console.log(t),e.ok(t)},e.ok=function(e){o.success("Avatar has been updated"),i.close(e)},e.cancel=function(){i.dismiss()}}]),mainApp.controller("dlgChangePasswordController",["$scope","userService","$uibModalInstance","Notification",function(e,r,t,n){e.interacted=function(r){return e.submitted||r.$dirty},e.init=function(){e.failed=!1,e.submitted=!1,e.model={}},e.init(),e.changePassword=function(e){return r.changePassword(e).$promise},e.submit=function(){e.submitted=!0,e.frmPassword.$valid&&e.changePassword(e.model).then(function(r){r.result?e.ok():(e.failed=!0,n.error("Failed to update your password"))})},e.ok=function(e){n.success("Password has been changed successfully"),t.close(e)},e.cancel=function(){t.dismiss()}}]),mainApp.controller("userController",["$scope","userService","imageService","$uibModal",function(e,r,t,n){e.getCurrentUserProfile=function(){return r.getCurrentUserProfile().$promise},e.init=function(){e.currentUser=e.currentUser||null,null==e.currentUser&&e.getCurrentUserProfile().then(function(r){e.currentUser=r})},e.init(),e.updateAvatar=function(){var r=n.open({animation:!1,templateUrl:"app/main/user/dlg-change-avatar.html",controller:"dlgChangeAvatarController",size:"lg",windowClass:"portraitDialog"});r.result.then(function(r){e.currentUser=r,e.currentUser.avatar.url=e.currentUser.avatar.url+"?"+(new Date).getTime(),e.$emit("user:updateAvatar",e.currentUser.avatar.url)},function(){})}}]),mainApp.controller("userDefaultController",["$scope","userService","$uibModal","Notification","$q",function(e,r,t,n,a){e.updateCurrentUserProfile=function(e){return r.updateCurrentUserProfile(e).$promise},e.updateProfile=function(){e.userForm.$valid&&e.updateCurrentUserProfile(e.currentUser).then(function(e){n.success("Update successfully")})},e.changePassword=function(){var e=t.open({animation:!1,templateUrl:"app/main/user/dlg-change-password.html",controller:"dlgChangePasswordController",size:"md",windowClass:"passswordDialog"});e.result.then(function(e){},function(){})},e.validateBankNumber=function(t){var n=a.defer();return r.checkBankNumber({number:t,userName:e.currentUser.userName},function(e){e.result?n.resolve(e):n.reject(e)}),n.promise}}]),mainApp.controller("userRegisterController",["$scope","userService","Notification","$state","$q",function(e,r,t,n,a){e.init=function(){e.newUser={userInfo:{}},e.submitted=!1},e.init(),e.registerUser=function(){e.submitted=!0,e.regForm.$valid&&(e.newUser.userInfo.parentId=e.currentUser.userName,r.register(e.newUser,function(e){t.success("Register successfully"),n.reload()}))},e.interacted=function(r){return e.submitted||r.$dirty},e.validateBankNumber=function(e){var t=a.defer();return r.checkBankNumber({number:e,userName:"*"},function(e){e.result?t.resolve(e):t.reject(e)}),t.promise},e.canIntroduce=function(){return null==e.currentUser||e.currentUser.userName.endsWith("A")||!e.currentUser.parentId}}]),mainApp.factory("userService",["$resource",function(e){return e(":path",{},{getCurrentUserContext:{method:"GET",params:{path:"api/user/getCurrentUserContext"}},getCurrentUserProfile:{method:"GET",params:{path:"api/user/getCurrent"}},getCurrentUserPinInfo:{method:"GET",params:{path:"api/user/getCurrentPin"}},getChildren:{method:"GET",params:{path:"api/user/getChildren",id:"id"},isArray:!0},register:{method:"POST",params:{path:"api/account/register",registerVM:"registerVM"},isArray:!0},updateCurrentUserProfile:{method:"POST",params:{path:"api/user/updateCurrent",userProfileVM:"userProfileVM"}},updateAvatar:{method:"POST",params:{path:"api/user/updateAvatar",avatar:"avatar"}},changePassword:{method:"POST",params:{path:"api/user/changePassword",model:"model"}},checkName:{method:"GET",params:{path:"api/user/checkName",name:"@name"}},checkBankNumber:{method:"GET",params:{path:"api/user/checkBankNumber",number:"@number",userName:"@userName"}},getCurrentAssociation:{method:"GET",params:{path:"api/user/getCurrentAssociation"},isArray:!0}})}]),mainApp.controller("userTreeController",["$scope","userService","_",function(e,r,t){e.getCurrentUserProfile=function(){return r.getCurrentUserProfile().$promise},e.getUserChildren=function(e){return r.getChildren({id:e}).$promise},e.init=function(){e.data=[],e.loadData()},e.loadData=function(){e.getCurrentUserProfile().then(function(r){e.data.push({id:r.id,title:r.displayName,name:r.userName})})},e.loadDataForSingleNode=function(r){r.isLoaded||(r.isLoaded=!0,e.getUserChildren(r.id).then(function(e){r.nodes=t.map(e,function(e){return{id:e.id,title:e.displayName,name:e.userName}})}))},e.init()}]);