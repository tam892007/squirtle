var authApp=angular.module("authApp",["LocalStorageModule","commonApp"]);authApp.controller("loginController",["$scope","$location","authService","ngAuthSettings",function(e,t,r,n){e.loginData={userName:"",password:"",useRefreshTokens:!0},e.message="",e.login=function(){r.login(e.loginData).then(function(e){t.path("/")},function(t){e.message=t.error_description})},e.authExternalProvider=function(t){var r=location.protocol+"//"+location.host+"/authcomplete.html",o=n.apiServiceBaseUri+"api/Account/ExternalLogin?provider="+t+"&response_type=token&client_id="+n.clientId+"&redirect_uri="+r;window.$windowScope=e;window.open(o,"Authenticate Account","location=0,status=0,width=600,height=750")},e.authCompletedCB=function(n){e.$apply(function(){if("False"==n.haslocalaccount)r.logOut(),r.externalAuthData={provider:n.provider,userName:n.external_user_name,externalAccessToken:n.external_access_token},t.path("/associate");else{var o={provider:n.provider,externalAccessToken:n.external_access_token};r.obtainAccessToken(o).then(function(e){t.path("/")},function(t){e.message=t.error_description})}})}}]),authApp.controller("refreshController",["$scope","$location","authService",function(e,t,r){e.authentication=r.authentication,e.tokenRefreshed=!1,e.tokenResponse=null,e.refreshToken=function(){r.refreshToken().then(function(t){e.tokenRefreshed=!0,e.tokenResponse=t,console.log(t)},function(e){t.path("/login")})},e.refreshToken()}]),authApp.factory("authInterceptorService",["$q","$injector","$location","localStorageService",function(e,t,r,n){var o={},s=function(e){e.headers=e.headers||{};var t=n.get("authorizationData");return t&&(e.headers.Authorization="Bearer "+t.token),e},a=function(o){if(401===o.status){var s=t.get("authService"),a=n.get("authorizationData");if(a&&a.useRefreshTokens){var i=t.get("$state");return s.refreshToken().then(function(e){i.reload()},function(e){r.path("/login")}),e.reject(o)}console.log(2),s.logOut(),r.path("/login")}return e.reject(o)};return o.request=s,o.responseError=a,o}]),authApp.factory("authService",["$http","$q","localStorageService","ngAuthSettings",function(e,t,r,n){var o=n.apiServiceBaseUri,s={},a={isAuth:!1,userName:"",useRefreshTokens:!1},i={provider:"",userName:"",externalAccessToken:""},u=function(t){return h(),e.post(o+"api/account/register",t).then(function(e){return e})},c=function(s){var i="grant_type=password&username="+s.userName+"&password="+s.password;s.useRefreshTokens&&(i=i+"&client_id="+n.clientId);var u=t.defer();return e.post(o+"token",i,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){s.useRefreshTokens?r.set("authorizationData",{token:e.access_token,userName:s.userName,refreshToken:e.refresh_token,useRefreshTokens:!0}):r.set("authorizationData",{token:e.access_token,userName:s.userName,refreshToken:"",useRefreshTokens:!1}),a.isAuth=!0,a.userName=s.userName,a.useRefreshTokens=s.useRefreshTokens,u.resolve(e)}).error(function(e,t){h(),u.reject(e)}),u.promise},h=function(){r.remove("authorizationData"),a.isAuth=!1,a.userName="",a.useRefreshTokens=!1},f=function(){var e=r.get("authorizationData");e&&(a.isAuth=!0,a.userName=e.userName,a.useRefreshTokens=e.useRefreshTokens)},l=function(){var a=t.defer(),i=r.get("authorizationData");if(i&&!s.tokenRefreshing&&i.useRefreshTokens){s.tokenRefreshing=!0;var u="grant_type=refresh_token&refresh_token="+i.refreshToken+"&client_id="+n.clientId;e.post(o+"token",u,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){r.set("authorizationData",{token:e.access_token,userName:e.userName,refreshToken:e.refresh_token,useRefreshTokens:!0}),a.resolve(e)}).error(function(e,t){h(),a.reject(e)})["finally"](function(){s.tokenRefreshing=!1})}return a.promise},p=function(n){var s=t.defer();return e.get(o+"api/account/ObtainLocalAccessToken",{params:{provider:n.provider,externalAccessToken:n.externalAccessToken}}).success(function(e){r.set("authorizationData",{token:e.access_token,userName:e.userName,refreshToken:"",useRefreshTokens:!1}),a.isAuth=!0,a.userName=e.userName,a.useRefreshTokens=!1,s.resolve(e)}).error(function(e,t){h(),s.reject(e)}),s.promise},k=function(n){var s=t.defer();return e.post(o+"api/account/registerexternal",n).success(function(e){r.set("authorizationData",{token:e.access_token,userName:e.userName,refreshToken:"",useRefreshTokens:!1}),a.isAuth=!0,a.userName=e.userName,a.useRefreshTokens=!1,s.resolve(e)}).error(function(e,t){h(),s.reject(e)}),s.promise};return s.saveRegistration=u,s.login=c,s.logOut=h,s.fillAuthData=f,s.authentication=a,s.refreshToken=l,s.obtainAccessToken=p,s.externalAuthData=i,s.registerExternal=k,s}]);