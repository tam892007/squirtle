var mainApp=angular.module("mainApp",["ui.router","ui.bootstrap","authApp","ngResource","ui.tree","smart-table","underscore","angularFileUpload","ngImgCrop","ngMessages","angular-loading-bar","ui.validate"]);mainApp.config(["$stateProvider","$urlRouterProvider",function(e,r){r.otherwise("/"),e.state("home",{url:"/",templateUrl:"app/main/home/home.html"}).state("login",{url:"/login",templateUrl:"app/authentication/login/login.html",controller:"loginController"}).state("refresh",{url:"/refresh",templateUrl:"app/authentication/refresh/refresh.html",controller:"refreshController"}).state("pin",{url:"/pin",templateUrl:"app/main/pin/pin.html",controller:"pinController"}).state("user",{"abstract":!0,url:"/user",templateUrl:"app/main/user/user-info.html",controller:"userController"}).state("user.default",{url:"/",templateUrl:"app/main/user/user-info.default.html",controller:"userDefaultController"}).state("user.register",{url:"/register",templateUrl:"app/main/user/user-info.register.html",controller:"userRegisterController"}).state("user.tree",{url:"/tree",templateUrl:"app/main/user/user-info.tree.html",controller:"userTreeController"})}]),mainApp.config(["$httpProvider",function(e){e.interceptors.push("authInterceptorService")}]),mainApp.run(["authService",function(e){e.fillAuthData()}]),mainApp.config(["treeConfig",function(e){e.defaultCollapsed=!0}]),mainApp.config(["cfpLoadingBarProvider",function(e){e.includeSpinner=!1}]),mainApp.controller("indexController",["$scope","$location","authService",function(e,r,t){e.logOut=function(){t.logOut(),r.path("/home")},e.authentication=t.authentication}]),mainApp.controller("pinController",["$scope","userService","pinService",function(e,r,t){e.getCurrentUserPinInfo=function(){return r.getCurrentUserPinInfo().$promise},e.getCurrentUserPinTransactionHistory=function(){return t.getCurrentUserHistory().$promise},e.init=function(){e.currentPinBalance={},e.transactionHistories=[],e.getCurrentUserPinInfo().then(function(r){e.currentPinBalance=r}),e.getCurrentUserPinTransactionHistory().then(function(r){e.transactionHistories=r}),e.transaction={}},e.init(),e.transferPIN=function(){t.transfer(e.transaction,function(r){e.init()})}}]),mainApp.factory("pinService",["$resource",function(e){return e(":path",{},{transfer:{method:"POST",params:{path:"api/pin/transfer",transactionVM:"transactionVM"}},getCurrentUserHistory:{method:"GET",params:{path:"api/pin/getAll"},isArray:!0}})}]),mainApp.controller("dlgChangeAvatarController",["$scope","userService","FileUploader","_","localStorageService","$uibModalInstance",function(e,r,t,n,i,a){e.uploadImage=function(){var e=n.last(o.queue);e.upload()};var o=e.uploader=new t({autoUpload:!1,url:"api/user/updateAvatar",queueLimit:1});o.filters.push({name:"size",fn:function(e){return e.size<=5242880}}),o.filters.push({name:"image",fn:function(e){return o.hasHTML5?/\/(png|jpeg|jpg)$/.test(e.file.type):!0}});var u=i.get("authorizationData");u&&(o.headers.Authorization="Bearer "+u.token),o.onAfterAddingFile=function(r){e.cropped={image:""};var t=new FileReader;t.onload=function(r){e.$apply(function(){e.image=r.target.result})},t.readAsDataURL(r._file)},o.onBeforeUploadItem=function(r){var t=s(e.cropped.image);r._file=t};var s=function(e){var r;r=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):decodeURI(e.split(",")[1]);for(var t=e.split(",")[0].split(":")[1].split(";")[0],n=[],i=0;i<r.length;i++)n.push(r.charCodeAt(i));return new Blob([new Uint8Array(n)],{type:t})};o.onSuccessItem=function(r,t,n,i){console.log(t),e.ok(t)},e.ok=function(e){a.close(e)},e.cancel=function(){a.dismiss()}}]),mainApp.controller("dlgChangePasswordController",["$scope","userService","$uibModalInstance",function(e,r,t){e.interacted=function(r){return e.submitted||r.$dirty},e.init=function(){e.submitted=!1,e.model={}},e.init(),e.changePassword=function(e){return r.changePassword(e).$promise},e.submit=function(){e.submitted=!0,e.frmPassword.$valid&&e.changePassword(e.model).then(function(r){r.result&&e.ok()})},e.ok=function(e){t.close(e)},e.cancel=function(){t.dismiss()}}]),mainApp.controller("userController",["$scope","userService","imageService","$uibModal",function(e,r,t,n){e.getCurrentUserProfile=function(){return r.getCurrentUserProfile().$promise},e.init=function(){e.currentUser=e.currentUser||null,null==e.currentUser&&e.getCurrentUserProfile().then(function(r){e.currentUser=r})},e.init(),e.updateAvatar=function(){var r=n.open({animation:!1,templateUrl:"app/main/user/dlg-change-avatar.html",controller:"dlgChangeAvatarController",size:"lg",windowClass:"portraitDialog"});r.result.then(function(r){e.currentUser=r,e.currentUser.avatar.url=e.currentUser.avatar.url+"?"+(new Date).getTime()},function(){})}}]),mainApp.controller("userDefaultController",["$scope","userService","$uibModal",function(e,r,t){e.updateCurrentUserProfile=function(e){return r.updateCurrentUserProfile(e).$promise},e.updateProfile=function(){e.userForm.$valid&&e.updateCurrentUserProfile(e.currentUser).then(function(e){})},e.changePassword=function(){var e=t.open({animation:!1,templateUrl:"app/main/user/dlg-change-password.html",controller:"dlgChangePasswordController",size:"md",windowClass:"passswordDialog"});e.result.then(function(e){},function(){})}}]),mainApp.controller("userRegisterController",["$scope","userService",function(e,r){e.init=function(){e.newUser={userInfo:{}},e.submitted=!1},e.init(),e.registerUser=function(){e.submitted=!0,e.regForm.$valid&&(e.newUser.userInfo.parentId=e.currentUser.userName,r.register(e.newUser,function(e){}))},e.interacted=function(r){return e.submitted||r.$dirty}}]),mainApp.factory("userService",["$resource",function(e){return e(":path",{},{getCurrentUserProfile:{method:"GET",params:{path:"api/user/getCurrent"}},getCurrentUserPinInfo:{method:"GET",params:{path:"api/user/getCurrentPin"}},getChildren:{method:"GET",params:{path:"api/user/getChildren",id:"id"},isArray:!0},register:{method:"POST",params:{path:"api/account/register",registerVM:"registerVM"}},updateCurrentUserProfile:{method:"POST",params:{path:"api/user/updateCurrent",userProfileVM:"userProfileVM"}},updateAvatar:{method:"POST",params:{path:"api/user/updateAvatar",avatar:"avatar"}},changePassword:{method:"POST",params:{path:"api/user/changePassword",model:"model"}}})}]),mainApp.controller("userTreeController",["$scope","userService","_",function(e,r,t){e.getCurrentUserProfile=function(){return r.getCurrentUserProfile().$promise},e.getUserChildren=function(e){return r.getChildren({id:e}).$promise},e.init=function(){e.data=[],e.loadData()},e.loadData=function(){e.getCurrentUserProfile().then(function(r){e.data.push({id:r.id,title:r.displayName,name:r.userName})})},e.loadDataForSingleNode=function(r){r.isLoaded||(r.isLoaded=!0,e.getUserChildren(r.id).then(function(e){r.nodes=t.map(e,function(e){return{id:e.id,title:e.displayName,name:e.userName}})}))},e.init()}]);